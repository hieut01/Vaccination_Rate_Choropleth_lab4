<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WA COVID-19 Vaccination Rates</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>
  <style>
    h2, h3 { margin: 10px; font-size: 18px; }
    h3 { font-size: 16px; }
    p { margin: 10px; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .map-overlay {
      position: absolute; background: rgba(255,255,255,0.8);
      border: 1px solid rgba(0,0,0,0.2); border-radius: 3px;
      font-family: Arial, sans-serif;
    }
    #features { top: 0; left: 0; height: 140px; margin: 20px; width: 260px; }
    #legend { bottom: 30px; left: 0; margin: 20px; padding: 10px; width: 180px; }
    .legend-key {
      display: inline-block; width: 10px; height: 10px; margin-right: 5px;
      border-radius: 20%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-overlay" id="features">
    <h2>WA COVID-19 Fully Vaccinated Rate (per 10k)</h2>
    <div id="text-description"><p>Hover over a county!</p></div>
  </div>
  <div class="map-overlay" id="legend"></div>

  <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiaGlldXRyYW4yIiwiYSI6ImNtaGVkdnNvNTBkNG0ybXExNjFobWFpMm8ifQ.csZ4K-7ctmQ5pw29u2U5Pw';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-120, 47.5],
    zoom: 6.5
  });

  async function geojsonFetch() {
    let response = await fetch('assets/wa-covid-data-102521.geojson');
    let covidData = await response.json();

    map.on('load', function loadingData() {
      map.addSource('covidData', { type: 'geojson', data: covidData });

      map.addLayer({
        'id': 'covid-layer',
        'type': 'fill',
        'source': 'covidData',
        'paint': {
          'fill-color': [
            'step',
            ['get', 'fullyVaxPer10k'],
            '#f2f0f7', 1000,
            '#cbc9e2', 2000,
            '#9e9ac8', 4000,
            '#756bb1', 6000,
            '#54278f'
          ],
          'fill-outline-color': '#BBBBBB',
          'fill-opacity': 0.75
        }
      });

      const layers = [
        '0-999','1000-1999','2000-3999','4000-5999','6000+'
      ];
      const colors = [
        '#f2f0f770','#cbc9e270','#9e9ac870','#756bb170','#54278f70'
      ];

      const legend = document.getElementById('legend');
      legend.innerHTML = "<b>Vaccinated (per 10k)</b><br><br>";
      layers.forEach((layer, i) => {
        const color = colors[i];
        const item = document.createElement('div');
        const key = document.createElement('span');
        key.className = 'legend-key';
        key.style.backgroundColor = color;
        const value = document.createElement('span');
        value.innerHTML = layer;
        item.appendChild(key);
        item.appendChild(value);
        legend.appendChild(item);
      });

      map.on('mousemove', ({point}) => {
        const county = map.queryRenderedFeatures(point, { layers: ['covid-layer'] });
        document.getElementById('text-description').innerHTML = county.length ?
          `<h3>${county[0].properties.name}</h3>
           <p><strong>${county[0].properties.fullyVaxPer10k}</strong> per 10k people fully vaccinated</p>` :
          `<p>Hover over a county!</p>`;
      });
    });
  }
  geojsonFetch();
  </script>
</body>
</html>
